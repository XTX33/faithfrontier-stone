{%- comment -%}
Usage:
  {% include opra-list.html status="Awaiting Response" %}
  {% include opra-list.html status="Active" %}
  {% include opra-list.html status="ALL" %}
  {% include opra-list.html authorities="Atlantic County Sheriff's Office|ACIA" %}
  {% include opra-list.html case="atl-l-003252-25" %}

Data sources (preferred):
  - _data/opra.yml
  - _data/opra_case_map.yml

Fallback:
  - site.opra collection
{%- endcomment -%}

{%- assign want_status = include.status | default: "ALL" -%}
{%- assign authorities = include.authorities | default: "" -%}
{%- assign auth_list = authorities | split: "|" -%}
{%- assign want_case = include.case | default: "" -%}

{%- assign opra_items = site.data.opra -%}
{%- assign opra_case_map = site.data.opra_case_map -%}

{%- comment -%}
If _data/opra.yml is not present yet, fall back to the collection.
{%- endcomment -%}
{%- if opra_items == nil or opra_items.size == 0 -%}
  {%- assign opra_items = site.opra -%}
{%- endif -%}

{%- assign sorted = opra_items | sort: "opened" | reverse -%}

<ul class="record-list">
  {%- for r in sorted -%}
    {%- assign rid = r.id | default: r.slug -%}
    {%- assign ok_status = true -%}
    {%- assign ok_auth = true -%}
    {%- assign ok_case = true -%}

    {%- comment -%}
      Status filter
    {%- endcomment -%}
    {%- if want_status != "ALL" and r.status != want_status -%}
      {%- assign ok_status = false -%}
    {%- endif -%}

    {%- comment -%}
      Authority filter (primary and parallel)
    {%- endcomment -%}
    {%- if authorities != "" -%}
      {%- assign ok_auth = false -%}
      {%- for a in auth_list -%}
        {%- assign a_trim = a | strip -%}
        {%- if r.authority_primary and (r.authority_primary contains a_trim or r.authority_primary == a_trim) -%}
          {%- assign ok_auth = true -%}
        {%- endif -%}
        {%- if r.authority_parallel -%}
          {%- for ap in r.authority_parallel -%}
            {%- if ap contains a_trim or ap == a_trim -%}
              {%- assign ok_auth = true -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- comment -%}
      Case filter (via _data/opra_case_map.yml)
      Expected mapping format (recommended):
        <case_slug>:
          - <opra_id_or_slug>
          - ...
    {%- endcomment -%}
    {%- if want_case != "" -%}
      {%- assign ok_case = false -%}
      {%- if opra_case_map and opra_case_map[want_case] -%}
        {%- assign mapped = opra_case_map[want_case] -%}
        {%- if mapped contains rid -%}
          {%- assign ok_case = true -%}
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}

    {%- if ok_status and ok_auth and ok_case -%}
      {%- comment -%}
        Internal link handling:
        - If r.url exists (collection item), use it.
        - If using _data/opra.yml, provide r.permalink or r.path if you store it.
      {%- endcomment -%}
      {%- assign internal_url = r.url -%}
      {%- if internal_url == nil and r.permalink -%}
        {%- assign internal_url = r.permalink -%}
      {%- endif -%}

      {%- comment -%}
        External OPRAMachine link handling:
        Prefer request thread URL; fall back to body URL.
        Support either key naming:
          - opramachine_request_url / opramachine_body_url (recommended)
          - opramachine_url (legacy in your older files)
      {%- endcomment -%}
      {%- assign ext_url = r.opramachine_request_url -%}
      {%- if ext_url == nil or ext_url == "" -%}
        {%- assign ext_url = r.opramachine_body_url -%}
      {%- endif -%}
      {%- if ext_url == nil or ext_url == "" -%}
        {%- assign ext_url = r.opramachine_url -%}
      {%- endif -%}

      <li class="record-item">
        <div class="record-item__title">
          {%- if internal_url -%}
            <a href="{{ internal_url | relative_url }}"><strong>{{ r.title | escape }}</strong></a>
          {%- else -%}
            <strong>{{ r.title | escape }}</strong>
          {%- endif -%}

          {%- if ext_url -%}
            <a class="record-ext" href="{{ ext_url | escape }}" target="_blank" rel="noopener">
              OPRAMachine â†—
            </a>
          {%- endif -%}
        </div>

        <div class="record-meta">
          {%- if r.status -%}
            <span class="badge badge-status">{{ r.status | escape }}</span>
          {%- endif -%}
          {%- if r.opened -%}
            <span class="meta">Opened: {{ r.opened }}</span>
          {%- endif -%}
          {%- if r.authority_primary -%}
            <span class="meta">Custodian: {{ r.authority_primary | escape }}</span>
          {%- endif -%}
        </div>
      </li>
    {%- endif -%}
  {%- endfor -%}
</ul>
